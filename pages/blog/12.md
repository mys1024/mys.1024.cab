---
layout: blog
type: md
bid: 12
title: ç”¨ Web Worker ä¼˜åŒ–è€—æ—¶è®¡ç®—
time: 2024-03-27T16:27:17.267Z
tags:
  - æŠ€æœ¯
  - å‰ç«¯
  - Web Workers API
---

ä¸‹é¢è¿™ä¸ªå‡½æ•°é€šè¿‡é€’å½’æ±‚è§£æ–æ³¢é‚£å¥‘æ•°åˆ—çš„ç¬¬ n é¡¹ï¼Œå…¶æ—¶é—´å¤æ‚åº¦ä¸º O(2^n)ï¼š

```javascript
function fib(n) {
  return n <= 2 ? 1 : fib(n - 1) + fib(n - 2);
}
```

å½“ n è¾¾åˆ° 45 æ—¶ï¼Œåœ¨æˆ‘çš„ç”µè„‘ä¸Šéœ€è¦ 5 ç§’æ‰èƒ½è®¡ç®—å‡ºç»“æœã€‚5 ç§’ï¼ŒemmğŸ¤”... ä¼¼ä¹ä¹Ÿè¿˜å¥½ï¼Œæœ‰æ—¶ä¸€ä¸ªç½‘ç»œè¯·æ±‚ä¹Ÿéœ€è¦ç­‰ 5 ç§’æ‰èƒ½æ‹¿åˆ°å“åº”ã€‚

ç„¶è€Œå¦‚æœå®é™…è·‘ä¸€ä¸‹ `fib(45)`ï¼Œå°±ä¼šå‘ç°äºŒè€…çš„ 5 ç§’æœ‰ç€å·¨å¤§çš„å·®å¼‚ â€”â€” `fib(45)` ä¼šè®©é¡µé¢å¡ä½æ•´æ•´ 5 ç§’ï¼Œè€Œç½‘ç»œè¯·æ±‚ä¸ä¼šã€‚

é€ æˆè¿™ç§å·®å¼‚çš„åŸå› æ˜¯ç½‘ç»œè¯·æ±‚æ˜¯ç”±ä¸“é—¨çš„è¯·æ±‚çº¿ç¨‹æ¥å¤„ç†çš„ï¼ŒJS ä¸»çº¿ç¨‹ä¸éœ€è¦å…³å¿ƒç½‘ç»œè¯·æ±‚çš„å…·ä½“å¤„ç†ï¼Œä»…åœ¨ç½‘ç»œè¯·æ±‚å®Œæˆä¹‹å JS ä¸»çº¿ç¨‹æ‰ä¼šå»æ‰§è¡Œå…¶å›è°ƒå‡½æ•°ã€‚è€Œ `fib(45)` åˆ™æ˜¯åœ¨ JS ä¸»çº¿ç¨‹ä¸­ç›´æ¥æ‰§è¡Œï¼Œåœ¨è¿™ä¸ªå‡½æ•°æ‰§è¡Œå®Œæˆä¹‹å‰ï¼ŒJS ä¸»çº¿ç¨‹éƒ½æ— æ³•æ‰§è¡Œåœ¨äº‹ä»¶å¾ªç¯çš„ä»»åŠ¡é˜Ÿåˆ—ä¸­çš„å…¶å®ƒä»»åŠ¡ï¼Œä½¿å¾—æ‰€æœ‰äº‹ä»¶ï¼ˆä¾‹å¦‚ç‚¹å‡»äº‹ä»¶ï¼‰çš„å›è°ƒå‡½æ•°éƒ½æ— æ³•å¾—åˆ°åŠæ—¶çš„æ‰§è¡Œã€‚

## Web Worker

è§£å†³åŠæ³•å¾ˆç®€å•ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ [Web Worker](https://developer.mozilla.org/zh-CN/docs/Web/API/Web_Workers_API) æ¥æ‰§è¡Œè¿™ç§è€—æ—¶è®¡ç®—ã€‚Worker æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªç‹¬ç«‹äºä¸»çº¿ç¨‹çš„çº¿ç¨‹ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ Worker çº¿ç¨‹ä¸­æ‰§è¡Œè€—æ—¶çš„è®¡ç®—ï¼Œè€Œä¸ä¼šå½±å“ä¸»çº¿ç¨‹æ‰§è¡Œå…¶å®ƒä»»åŠ¡ã€‚

ä»¥ä¸‹æ˜¯ä¸€ä¸ªä½¿ç”¨ Worker çš„ç®€å•ä¾‹å­ï¼Œé€šè¿‡ `new Worker()` åˆ›å»ºä¸€ä¸ª Worker å®ä¾‹å¹¶åŠ è½½ä¸æ‰§è¡Œ `worker.js` æ–‡ä»¶ï¼š

```javascript
const worker = new Worker(new URL('./worker.js', import.meta.url), {
  type: 'module'
})

worker.addEventListener('message', (event) => {
  console.log(event.data) // æ¥è‡ª Worker çš„æ•°æ®
})

worker.postMessage({
  // å‘é€ç»™ Worker çš„æ•°æ®
})
```

åˆ«çš„è¯­è¨€ï¼ˆå¦‚ Cã€Javaï¼‰çš„çº¿ç¨‹ä¹‹é—´é€šå¸¸å¯ä»¥å…±äº«å†…å­˜ï¼Œä¸åŒçº¿ç¨‹å¯ä»¥è®¿é—®å†…å­˜ä¸­çš„åŒä¸€ä¸ªå˜é‡ï¼Œä»è€Œå®ç°çº¿ç¨‹é—´çš„é€šä¿¡ã€‚è€Œåœ¨ JS é‡Œï¼Œçº¿ç¨‹çš„æ‰§è¡Œç¯å¢ƒæ˜¯ç›¸äº’éš”ç¦»çš„ï¼Œçº¿ç¨‹ä¹‹é—´ä¸èƒ½é€šè¿‡å…±äº«å†…å­˜æ¥è¿›è¡Œé€šä¿¡ã€‚

åœ¨ JS é‡Œï¼Œåœ¨ä¸»çº¿ç¨‹ä¸­éœ€è¦é€šè¿‡ `worker.addEventListener()` ç›‘å¬æ¥è‡ª Worker çº¿ç¨‹çš„æ¶ˆæ¯ï¼Œå¹¶é€šè¿‡ `worker.postMessage()` å‘ Worker çº¿ç¨‹å‘é€æ¶ˆæ¯ã€‚è€Œ Worker çº¿ç¨‹åˆ™åŒæ ·é€šè¿‡å…¶å…¨å±€å¯¹è±¡ä¸Šçš„ `addEventListener()` ä¸ `postMessage()` æ¥ä¸ä¸»çº¿ç¨‹è¿›è¡Œé€šä¿¡ã€‚

è¿™ç§ä¸åŸºäºå…±äº«å†…å­˜ï¼Œè€Œæ˜¯åŸºäºæ¶ˆæ¯äº‹ä»¶çš„é€šä¿¡æœºåˆ¶çœ‹èµ·æ¥éº»çƒ¦äº†ç‚¹ï¼Œä½†å¥½å¤„æ˜¯å·¨å¤§çš„ â€”â€” å¯ä»¥ä¿è¯å¯¹å˜é‡çš„è®¿é—®æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œä¸éœ€è¦è€ƒè™‘åŠ é”ï¼Œä¸ä¼šæ‰“ç ´æˆ‘ä»¬åœ¨å•çº¿ç¨‹ç¼–ç¨‹ä¸­çš„æ€ç»´ä¹ æƒ¯ï¼Œä¹Ÿé¿å…äº†å„ç§åŒæ­¥æœºåˆ¶é€ æˆçš„æ€§èƒ½æµªè´¹ã€‚

## å®è·µä¸€ä¸‹

ä¸‹é¢ç®€å•åœ°å°è£…äº†ä¸€ä¸‹ Workerï¼Œå®ç°äº†åœ¨ Worker ä¸­è®¡ç®—æ–æ³¢é‚£å¥‘æ•°åˆ—çš„ç¬¬ n é¡¹ï¼Œå¹¶å°†è®¡ç®—ç»“æœå‘é€å›ä¸»çº¿ç¨‹ï¼š

`index.js`:

```javascript
export function fib(n) {
  const worker = new Worker(new URL('./worker.js', import.meta.url), {
    type: 'module',
  });

  const ret = new Promise((resolve) => {
    worker.addEventListener('message', (event) => {
      const { ret } = event.data;
      resolve(ret);
    });
  });
  worker.postMessage({ n });
  
  return ret;
}
```

`worker.js`:

```javascript
function fib(n) {
  return n <= 2 ? 1 : fib(n - 1) + fib(n - 2);
}

globalThis.addEventListener('message', (event) => {
  const { n } = event.data;
  const ret = fib(n);
  globalThis.postMessage({ ret });
});
```

è¿™æ—¶ï¼Œæ‰§è¡Œ `index.js` ä¸­çš„ `fib()` å°±ä¸ä¼šè®©é¡µé¢å¡ä½äº†ã€‚

## å¸¦è´§ç¯èŠ‚

ç”±äºç›´æ¥ä½¿ç”¨ `addEventListener()` ä¸ `postMessage()` ä¸ Worker è¿›è¡Œé€šä¿¡æ¯”è¾ƒéº»çƒ¦ï¼Œäºæ˜¯å‰æ®µæ—¶é—´æˆ‘å†™äº† **[worker-fn](https://www.npmjs.com/package/worker-fn)** è¿™ä¸ªåŒ…ã€‚

**worker-fn** å¯ä»¥éšè—ä¸»çº¿ç¨‹ä¸ Worker çº¿ç¨‹ä¹‹é—´çš„é€šä¿¡ç»†èŠ‚ï¼Œåœ¨ä¸»çº¿ç¨‹ä¸­å¯ä»¥åˆ›å»ºä¸€ä¸ªæœ‰ç€ç›¸åŒå‡½æ•°ç­¾åçš„ä»£ç†å‡½æ•°ï¼Œä»£ç†å‡½æ•°ä¼šè°ƒç”¨ Worker çº¿ç¨‹ä¸­å¯¹åº”çš„å·¥ä½œå‡½æ•°ï¼Œæ›´ç¬¦åˆæ­£å¸¸çš„ä»£ç ä¹ æƒ¯ã€‚

ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„ä½¿ç”¨ä¾‹å­ï¼š

`main.js`

```javascript
import { useWorkerFn } from "worker-fn";

const worker = new Worker(new URL("./math.worker.js", import.meta.url), {
  type: "module",
});

const fib = useWorkerFn("fib", worker);

console.log(await fib(3)); // 2
```

`math.worker.js`:

```typescript
import { defineWorkerFn } from "worker-fn";

function fib(n) {
  return n <= 2 ? 1 : fib(n - 1) + fib(n - 2);
}

defineWorkerFn("fib", fib);
```

æœ‰éœ€è¦ä½¿ç”¨ Worker çš„å°ä¼™ä¼´æ¬¢è¿å¼•å…¥ã€‚

## çº¿ä¸Š Demo

åœ¨è¿™é‡Œå¯ä»¥éªŒè¯ä¸€ä¸‹æœ¬æ–‡çš„ä»£ç ä¸ç»“è®ºï¼š[https://stackblitz.com/edit/mys1024-worker-demo](https://stackblitz.com/edit/mys1024-worker-demo?file=src%2Fmain.ts)
